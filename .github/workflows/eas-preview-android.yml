name: EAS Android Preview (APK)

on:
  workflow_dispatch:

jobs:
  build-android-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable corepack
        run: corepack enable

      - name: Install deps
        run: yarn --cwd frontend install --frozen-lockfile || yarn --cwd frontend install

      - name: Install Expo plugins (best-effort)
        run: |
          cd frontend
          npx expo install --non-interactive expo-av expo-image-manipulator expo-document-picker expo-file-system \
            expo-sharing expo-secure-store expo-sqlite expo-random @shopify/flash-list || true

      - name: Login to EAS
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
        run: |
          npx --yes eas-cli@latest whoami || npx --yes eas-cli@latest login --token "$EAS_TOKEN"

      - name: Build preview APK
        working-directory: frontend
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
        run: npx --yes eas-cli@latest build -p android --profile preview --non-interactive --json > build.json

      - name: Upload build.json
        uses: actions/upload-artifact@v4
        with:
          name: build-json
          path: frontend/build.json
